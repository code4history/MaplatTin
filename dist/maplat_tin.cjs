"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const sn=require("@turf/boolean-point-in-polygon"),rn=require("@turf/centroid"),_e=require("@turf/convex"),ft=require("@turf/helpers"),on=require("delaunator"),cn=require("@turf/line-intersect");var an=Object.defineProperty,fn=(o,t,n)=>t in o?an(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n,it=(o,t,n)=>fn(o,typeof t!="symbol"?t+"":t,n);const It=11102230246251565e-32,lt=134217729,hn=(3+8*It)*It;function ae(o,t,n,e,i){let s,r,c,h,f=t[0],l=e[0],a=0,u=0;l>f==l>-f?(s=f,f=t[++a]):(s=l,l=e[++u]);let d=0;if(a<o&&u<n)for(l>f==l>-f?(r=f+s,c=s-(r-f),f=t[++a]):(r=l+s,c=s-(r-l),l=e[++u]),s=r,c!==0&&(i[d++]=c);a<o&&u<n;)l>f==l>-f?(r=s+f,h=r-s,c=s-(r-h)+(f-h),f=t[++a]):(r=s+l,h=r-s,c=s-(r-h)+(l-h),l=e[++u]),s=r,c!==0&&(i[d++]=c);for(;a<o;)r=s+f,h=r-s,c=s-(r-h)+(f-h),f=t[++a],s=r,c!==0&&(i[d++]=c);for(;u<n;)r=s+l,h=r-s,c=s-(r-h)+(l-h),l=e[++u],s=r,c!==0&&(i[d++]=c);return(s!==0||d===0)&&(i[d++]=s),d}function un(o,t){let n=t[0];for(let e=1;e<o;e++)n+=t[e];return n}function Kt(o){return new Float64Array(o)}const ln=(3+16*It)*It,dn=(2+12*It)*It,pn=(9+64*It)*It*It,Ut=Kt(4),xe=Kt(8),Me=Kt(12),Se=Kt(16),pt=Kt(4);function gn(o,t,n,e,i,s,r){let c,h,f,l,a,u,d,y,g,m,w,S,E,O,R,I,F,q;const L=o-i,tt=n-i,et=t-s,z=e-s;O=L*z,u=lt*L,d=u-(u-L),y=L-d,u=lt*z,g=u-(u-z),m=z-g,R=y*m-(O-d*g-y*g-d*m),I=et*tt,u=lt*et,d=u-(u-et),y=et-d,u=lt*tt,g=u-(u-tt),m=tt-g,F=y*m-(I-d*g-y*g-d*m),w=R-F,a=R-w,Ut[0]=R-(w+a)+(a-F),S=O+w,a=S-O,E=O-(S-a)+(w-a),w=E-I,a=E-w,Ut[1]=E-(w+a)+(a-I),q=S+w,a=q-S,Ut[2]=S-(q-a)+(w-a),Ut[3]=q;let Z=un(4,Ut),p=dn*r;if(Z>=p||-Z>=p||(a=o-L,c=o-(L+a)+(a-i),a=n-tt,f=n-(tt+a)+(a-i),a=t-et,h=t-(et+a)+(a-s),a=e-z,l=e-(z+a)+(a-s),c===0&&h===0&&f===0&&l===0)||(p=pn*r+hn*Math.abs(Z),Z+=L*l+z*c-(et*f+tt*h),Z>=p||-Z>=p))return Z;O=c*z,u=lt*c,d=u-(u-c),y=c-d,u=lt*z,g=u-(u-z),m=z-g,R=y*m-(O-d*g-y*g-d*m),I=h*tt,u=lt*h,d=u-(u-h),y=h-d,u=lt*tt,g=u-(u-tt),m=tt-g,F=y*m-(I-d*g-y*g-d*m),w=R-F,a=R-w,pt[0]=R-(w+a)+(a-F),S=O+w,a=S-O,E=O-(S-a)+(w-a),w=E-I,a=E-w,pt[1]=E-(w+a)+(a-I),q=S+w,a=q-S,pt[2]=S-(q-a)+(w-a),pt[3]=q;const b=ae(4,Ut,4,pt,xe);O=L*l,u=lt*L,d=u-(u-L),y=L-d,u=lt*l,g=u-(u-l),m=l-g,R=y*m-(O-d*g-y*g-d*m),I=et*f,u=lt*et,d=u-(u-et),y=et-d,u=lt*f,g=u-(u-f),m=f-g,F=y*m-(I-d*g-y*g-d*m),w=R-F,a=R-w,pt[0]=R-(w+a)+(a-F),S=O+w,a=S-O,E=O-(S-a)+(w-a),w=E-I,a=E-w,pt[1]=E-(w+a)+(a-I),q=S+w,a=q-S,pt[2]=S-(q-a)+(w-a),pt[3]=q;const _=ae(b,xe,4,pt,Me);O=c*l,u=lt*c,d=u-(u-c),y=c-d,u=lt*l,g=u-(u-l),m=l-g,R=y*m-(O-d*g-y*g-d*m),I=h*f,u=lt*h,d=u-(u-h),y=h-d,u=lt*f,g=u-(u-f),m=f-g,F=y*m-(I-d*g-y*g-d*m),w=R-F,a=R-w,pt[0]=R-(w+a)+(a-F),S=O+w,a=S-O,E=O-(S-a)+(w-a),w=E-I,a=E-w,pt[1]=E-(w+a)+(a-I),q=S+w,a=q-S,pt[2]=S-(q-a)+(w-a),pt[3]=q;const M=ae(_,Me,4,pt,Se);return Se[M-1]}function wn(o,t,n,e,i,s){const r=(t-s)*(n-i),c=(o-i)*(e-s),h=r-c,f=Math.abs(r+c);return Math.abs(h)>=ln*f?h:-gn(o,t,n,e,i,s,f)}function mn(o,t){var n,e,i=0,s,r,c,h,f,l,a,u=o[0],d=o[1],y=t.length;for(n=0;n<y;n++){e=0;var g=t[n],m=g.length-1;if(l=g[0],l[0]!==g[m][0]&&l[1]!==g[m][1])throw new Error("First and last coordinates in a ring must be the same");for(r=l[0]-u,c=l[1]-d,e;e<m;e++){if(a=g[e+1],h=a[0]-u,f=a[1]-d,c===0&&f===0){if(h<=0&&r>=0||r<=0&&h>=0)return 0}else if(f>=0&&c<=0||f<=0&&c>=0){if(s=wn(r,h,c,f,0,0),s===0)return 0;(s>0&&f>0&&c<=0||s<0&&f<=0&&c>0)&&i++}l=a,c=f,r=h}}return i%2!==0}function Ve(o,t,n={}){const e={type:"Feature"};return(n.id===0||n.id)&&(e.id=n.id),n.bbox&&(e.bbox=n.bbox),e.properties=t||{},e.geometry=o,e}function zt(o,t,n={}){if(!o)throw new Error("coordinates is required");if(!Array.isArray(o))throw new Error("coordinates must be an Array");if(o.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!ve(o[0])||!ve(o[1]))throw new Error("coordinates must contain numbers");return Ve({type:"Point",coordinates:o},t,n)}function qe(o,t,n={}){for(const e of o){if(e.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(e[e.length-1].length!==e[0].length)throw new Error("First and last Position are not equivalent.");for(let i=0;i<e[e.length-1].length;i++)if(e[e.length-1][i]!==e[0][i])throw new Error("First and last Position are not equivalent.")}return Ve({type:"Polygon",coordinates:o},t,n)}function Ft(o,t={}){const n={type:"FeatureCollection"};return t.id&&(n.id=t.id),t.bbox&&(n.bbox=t.bbox),n.features=o,n}function ve(o){return!isNaN(o)&&o!==null&&!Array.isArray(o)}function bn(o){if(!o)throw new Error("coord is required");if(!Array.isArray(o)){if(o.type==="Feature"&&o.geometry!==null&&o.geometry.type==="Point")return[...o.geometry.coordinates];if(o.type==="Point")return[...o.coordinates]}if(Array.isArray(o)&&o.length>=2&&!Array.isArray(o[0])&&!Array.isArray(o[1]))return[...o];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Ae(o){if(Array.isArray(o))return o;if(o.type==="Feature"){if(o.geometry!==null)return o.geometry.coordinates}else if(o.coordinates)return o.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function yn(o){return o.type==="Feature"?o.geometry:o}function kn(o,t,n={}){if(!o)throw new Error("point is required");if(!t)throw new Error("polygon is required");const e=bn(o),i=yn(t),s=i.type,r=t.bbox;let c=i.coordinates;if(r&&_n(e,r)===!1)return!1;s==="Polygon"&&(c=[c]);let h=!1;for(var f=0;f<c.length;++f){const l=mn(e,c[f]);if(l===0)return!n.ignoreBoundary;l&&(h=!0)}return h}function _n(o,t){return t[0]<=o[0]&&t[1]<=o[1]&&t[2]>=o[0]&&t[3]>=o[1]}var we=kn;function Ee(o){const t=o.features;for(let n=0;n<t.length;n++){const e=t[n];`${e.properties.a.index}`.substring(0,1)==="b"&&`${e.properties.b.index}`.substring(0,1)==="b"?t[n]={geometry:{type:"Polygon",coordinates:[[e.geometry.coordinates[0][2],e.geometry.coordinates[0][0],e.geometry.coordinates[0][1],e.geometry.coordinates[0][2]]]},properties:{a:{geom:e.properties.c.geom,index:e.properties.c.index},b:{geom:e.properties.a.geom,index:e.properties.a.index},c:{geom:e.properties.b.geom,index:e.properties.b.index}},type:"Feature"}:`${e.properties.c.index}`.substring(0,1)==="b"&&`${e.properties.a.index}`.substring(0,1)==="b"&&(t[n]={geometry:{type:"Polygon",coordinates:[[e.geometry.coordinates[0][1],e.geometry.coordinates[0][2],e.geometry.coordinates[0][0],e.geometry.coordinates[0][1]]]},properties:{a:{geom:e.properties.b.geom,index:e.properties.b.index},b:{geom:e.properties.c.geom,index:e.properties.c.index},c:{geom:e.properties.a.geom,index:e.properties.a.index}},type:"Feature"})}return o}function ze(o){const t=["a","b","c","a"].map(s=>o.properties[s].geom),n=o.geometry.coordinates[0],e=o.properties,i={a:{geom:n[0],index:e.a.index},b:{geom:n[1],index:e.b.index},c:{geom:n[2],index:e.c.index}};return qe([t],i)}function xn(o){const t=[0,1,2,0].map(e=>o[e][0][0]),n={a:{geom:o[0][0][1],index:o[0][1]},b:{geom:o[1][0][1],index:o[1][1]},c:{geom:o[2][0][1],index:o[2][1]}};return qe([t],n)}function Gt(o,t,n,e,i,s=!1,r){const c=o.map(h=>{(!r||r<2.00703)&&(h=Xe(h));const f=isFinite(h)?t[h]:h==="c"?e:h==="b0"?i[0]:h==="b1"?i[1]:h==="b2"?i[2]:h==="b3"?i[3]:(function(){const l=h.match(/e(\d+)/);if(l){const a=parseInt(l[1]);return n[a]}throw"Bad index value for indexesToTri"})();return s?[[f[1],f[0]],h]:[[f[0],f[1]],h]});return xn(c)}function Xe(o){return typeof o=="number"?o:o.replace(/^(c|e|b)(?:ent|dgeNode|box)(\d+)?$/,"$1$2")}function We(o,t){return t&&t>=2.00703||Array.isArray(o[0])?o:o.map(n=>[n.illstNodes,n.mercNodes,n.startEnd])}function Oe(o,t){for(let n=0;n<t.features.length;n++)if(we(o,t.features[n]))return t.features[n]}function Ye(o,t,n){const e=t.geometry.coordinates[0][0],i=t.geometry.coordinates[0][1],s=t.geometry.coordinates[0][2],r=o.geometry.coordinates,c=t.properties.a.geom,h=t.properties.b.geom,f=t.properties.c.geom,l=[i[0]-e[0],i[1]-e[1]],a=[s[0]-e[0],s[1]-e[1]],u=[r[0]-e[0],r[1]-e[1]],d=[h[0]-c[0],h[1]-c[1]],y=[f[0]-c[0],f[1]-c[1]];let g=(a[1]*u[0]-a[0]*u[1])/(l[0]*a[1]-l[1]*a[0]),m=(l[0]*u[1]-l[1]*u[0])/(l[0]*a[1]-l[1]*a[0]);if(n){const w=n[t.properties.a.index],S=n[t.properties.b.index],E=n[t.properties.c.index];let O;if(g<0||m<0||1-g-m<0){const R=g/(g+m),I=m/(g+m);O=g/S/(R/S+I/E),m=m/E/(R/S+I/E)}else O=g/S/(g/S+m/E+(1-g-m)/w),m=m/E/(g/S+m/E+(1-g-m)/w);g=O}return[g*d[0]+m*y[0]+c[0],g*d[1]+m*y[1]+c[1]]}function Mn(o,t,n,e){const i=o.geometry.coordinates,s=n.geometry.coordinates,r=Math.atan2(i[0]-s[0],i[1]-s[1]),c=Sn(r,t[0]);if(c===void 0)throw new Error("Unable to determine vertex index");const h=t[1][c];return Ye(o,h.features[0],e)}function ie(o,t,n,e,i,s,r,c){let h;if(r&&(h=Oe(o,Ft([r]))),!h){if(n){const f=o.geometry.coordinates,l=n.gridNum,a=n.xOrigin,u=n.yOrigin,d=n.xUnit,y=n.yUnit,g=n.gridCache,m=vt(f[0],a,d,l),w=vt(f[1],u,y,l),S=g[m]?g[m][w]?g[m][w]:[]:[];t=Ft(S.map(E=>t.features[E]))}h=Oe(o,t)}return c&&c(h),h?Ye(o,h,s):Mn(o,e,i,s)}function vt(o,t,n,e){let i=Math.floor((o-t)/n);return i>=e&&(i=e-1),i}function Sn(o,t){let n=Ie(o-t[0]),e=Math.PI*2,i;for(let s=0;s<t.length;s++){const r=(s+1)%t.length,c=Ie(o-t[r]),h=Math.min(Math.abs(n),Math.abs(c));n*c<=0&&h<e&&(e=h,i=s),n=c}return i}function Ie(o,t=!1){const n=t?function(e){return!(e>=0&&e<Math.PI*2)}:function(e){return!(e>-1*Math.PI&&e<=Math.PI)};for(;n(o);)o=o+2*Math.PI*(o>0?-1:1);return o}const re=2.00703,kt=class _t{constructor(){it(this,"points",[]),it(this,"pointsWeightBuffer"),it(this,"strict_status"),it(this,"vertices_params"),it(this,"centroid"),it(this,"edgeNodes"),it(this,"edges"),it(this,"tins"),it(this,"kinks"),it(this,"yaxisMode",_t.YAXIS_INVERT),it(this,"strictMode",_t.MODE_AUTO),it(this,"vertexMode",_t.VERTEX_PLAIN),it(this,"bounds"),it(this,"boundsPolygon"),it(this,"wh"),it(this,"xy"),it(this,"indexedTins"),it(this,"stateFull",!1),it(this,"stateTriangle"),it(this,"stateBackward")}setCompiled(t){if(t.version||!t.tins&&t.points&&t.tins_points){this.points=t.points,this.pointsWeightBuffer=!t.version||t.version<2.00703?["forw","bakw"].reduce((e,i)=>{const s=t.weight_buffer[i];return s&&(e[i]=Object.keys(s).reduce((r,c)=>{const h=Xe(c);return r[h]=s[c],r},{})),e},{}):t.weight_buffer,t.strict_status?this.strict_status=t.strict_status:t.kinks_points?this.strict_status=_t.STATUS_ERROR:t.tins_points.length==2?this.strict_status=_t.STATUS_LOOSE:this.strict_status=_t.STATUS_STRICT,this.vertices_params={forw:[t.vertices_params[0]],bakw:[t.vertices_params[1]]},this.vertices_params.forw[1]=[0,1,2,3].map(e=>{const i=(e+1)%4,s=Gt(["c",`b${e}`,`b${i}`],t.points,t.edgeNodes||[],t.centroid_point,t.vertices_points,!1,re);return Ft([s])}),this.vertices_params.bakw[1]=[0,1,2,3].map(e=>{const i=(e+1)%4,s=Gt(["c",`b${e}`,`b${i}`],t.points,t.edgeNodes||[],t.centroid_point,t.vertices_points,!0,re);return Ft([s])}),this.centroid={forw:zt(t.centroid_point[0],{target:{geom:t.centroid_point[1],index:"c"}}),bakw:zt(t.centroid_point[1],{target:{geom:t.centroid_point[0],index:"c"}})},this.edges=We(t.edges||[]),this.edgeNodes=t.edgeNodes||[];const n=t.tins_points.length==1?0:1;this.tins={forw:Ft(t.tins_points[0].map(e=>Gt(e,t.points,t.edgeNodes||[],t.centroid_point,t.vertices_points,!1,t.version))),bakw:Ft(t.tins_points[n].map(e=>Gt(e,t.points,t.edgeNodes||[],t.centroid_point,t.vertices_points,!0,t.version)))},this.addIndexedTin(),t.kinks_points&&(this.kinks={bakw:Ft(t.kinks_points.map(e=>zt(e)))}),t.yaxisMode?this.yaxisMode=t.yaxisMode:this.yaxisMode=_t.YAXIS_INVERT,t.vertexMode&&(this.vertexMode=t.vertexMode),t.strictMode&&(this.strictMode=t.strictMode),t.bounds?(this.bounds=t.bounds,this.boundsPolygon=t.boundsPolygon,this.xy=t.xy,this.wh=t.wh):(this.xy=[0,0],t.wh&&(this.wh=t.wh),this.bounds=void 0,this.boundsPolygon=void 0)}else{t=JSON.parse(JSON.stringify(t).replace('"cent"','"c"').replace(/"bbox(\d+)"/g,'"b$1"')),this.tins=t.tins,this.addIndexedTin(),this.strict_status=t.strict_status,this.pointsWeightBuffer=t.weight_buffer,this.vertices_params=t.vertices_params,this.centroid=t.centroid,this.kinks=t.kinks;const n=[];for(let e=0;e<this.tins.forw.features.length;e++){const i=this.tins.forw.features[e];["a","b","c"].map((s,r)=>{const c=i.geometry.coordinates[0][r],h=i.properties[s].geom,f=i.properties[s].index;typeof f=="number"&&(n[f]=[c,h])})}this.points=n}}addIndexedTin(){const t=this.tins,n=t.forw,e=t.bakw,i=Math.ceil(Math.sqrt(n.features.length));if(i<3){this.indexedTins=void 0;return}let s=[],r=[];const c=n.features.map(g=>{let m=[];return Ae(g)[0].map(w=>{s.length===0?s=[Array.from(w),Array.from(w)]:(w[0]<s[0][0]&&(s[0][0]=w[0]),w[0]>s[1][0]&&(s[1][0]=w[0]),w[1]<s[0][1]&&(s[0][1]=w[1]),w[1]>s[1][1]&&(s[1][1]=w[1])),m.length===0?m=[Array.from(w),Array.from(w)]:(w[0]<m[0][0]&&(m[0][0]=w[0]),w[0]>m[1][0]&&(m[1][0]=w[0]),w[1]<m[0][1]&&(m[0][1]=w[1]),w[1]>m[1][1]&&(m[1][1]=w[1]))}),m}),h=(s[1][0]-s[0][0])/i,f=(s[1][1]-s[0][1])/i,l=c.reduce((g,m,w)=>{const S=vt(m[0][0],s[0][0],h,i),E=vt(m[1][0],s[0][0],h,i),O=vt(m[0][1],s[0][1],f,i),R=vt(m[1][1],s[0][1],f,i);for(let I=S;I<=E;I++){g[I]||(g[I]=[]);for(let F=O;F<=R;F++)g[I][F]||(g[I][F]=[]),g[I][F].push(w)}return g},[]),a=e.features.map(g=>{let m=[];return Ae(g)[0].map(w=>{r.length===0?r=[Array.from(w),Array.from(w)]:(w[0]<r[0][0]&&(r[0][0]=w[0]),w[0]>r[1][0]&&(r[1][0]=w[0]),w[1]<r[0][1]&&(r[0][1]=w[1]),w[1]>r[1][1]&&(r[1][1]=w[1])),m.length===0?m=[Array.from(w),Array.from(w)]:(w[0]<m[0][0]&&(m[0][0]=w[0]),w[0]>m[1][0]&&(m[1][0]=w[0]),w[1]<m[0][1]&&(m[0][1]=w[1]),w[1]>m[1][1]&&(m[1][1]=w[1]))}),m}),u=(r[1][0]-r[0][0])/i,d=(r[1][1]-r[0][1])/i,y=a.reduce((g,m,w)=>{const S=vt(m[0][0],r[0][0],u,i),E=vt(m[1][0],r[0][0],u,i),O=vt(m[0][1],r[0][1],d,i),R=vt(m[1][1],r[0][1],d,i);for(let I=S;I<=E;I++){g[I]||(g[I]=[]);for(let F=O;F<=R;F++)g[I][F]||(g[I][F]=[]),g[I][F].push(w)}return g},[]);this.indexedTins={forw:{gridNum:i,xOrigin:s[0][0],yOrigin:s[0][1],xUnit:h,yUnit:f,gridCache:l},bakw:{gridNum:i,xOrigin:r[0][0],yOrigin:r[0][1],xUnit:u,yUnit:d,gridCache:y}}}transform(t,n,e){if(n&&this.strict_status==_t.STATUS_ERROR)throw'Backward transform is not allowed if strict_status == "strict_error"';this.yaxisMode==_t.YAXIS_FOLLOW&&n&&(t=[t[0],-1*t[1]]);const i=zt(t);if(this.bounds&&!n&&!e&&!we(i,this.boundsPolygon))return!1;const s=n?this.tins.bakw:this.tins.forw,r=n?this.indexedTins.bakw:this.indexedTins.forw,c=n?this.vertices_params.bakw:this.vertices_params.forw,h=n?this.centroid.bakw:this.centroid.forw,f=n?this.pointsWeightBuffer.bakw:this.pointsWeightBuffer.forw;let l,a;this.stateFull&&(this.stateBackward==n?l=this.stateTriangle:(this.stateBackward=n,this.stateTriangle=void 0),a=d=>{this.stateTriangle=d});let u=ie(i,s,r,c,h,f,l,a);if(this.bounds&&n&&!e){const d=zt(u);if(!we(d,this.boundsPolygon))return!1}else this.yaxisMode==_t.YAXIS_FOLLOW&&!n&&(u=[u[0],-1*u[1]]);return u}};it(kt,"VERTEX_PLAIN","plain"),it(kt,"VERTEX_BIRDEYE","birdeye"),it(kt,"MODE_STRICT","strict"),it(kt,"MODE_AUTO","auto"),it(kt,"MODE_LOOSE","loose"),it(kt,"STATUS_STRICT","strict"),it(kt,"STATUS_ERROR","strict_error"),it(kt,"STATUS_LOOSE","loose"),it(kt,"YAXIS_FOLLOW","follow"),it(kt,"YAXIS_INVERT","invert");let vn=kt;const dt=11102230246251565e-32,N=134217729,Je=(3+8*dt)*dt;function at(o,t,n,e,i){let s,r,c,h,f=t[0],l=e[0],a=0,u=0;l>f==l>-f?(s=f,f=t[++a]):(s=l,l=e[++u]);let d=0;if(a<o&&u<n)for(l>f==l>-f?(r=f+s,c=s-(r-f),f=t[++a]):(r=l+s,c=s-(r-l),l=e[++u]),s=r,c!==0&&(i[d++]=c);a<o&&u<n;)l>f==l>-f?(r=s+f,h=r-s,c=s-(r-h)+(f-h),f=t[++a]):(r=s+l,h=r-s,c=s-(r-h)+(l-h),l=e[++u]),s=r,c!==0&&(i[d++]=c);for(;a<o;)r=s+f,h=r-s,c=s-(r-h)+(f-h),f=t[++a],s=r,c!==0&&(i[d++]=c);for(;u<n;)r=s+l,h=r-s,c=s-(r-h)+(l-h),l=e[++u],s=r,c!==0&&(i[d++]=c);return(s!==0||d===0)&&(i[d++]=s),d}function yt(o,t,n,e,i,s,r,c){return at(at(o,t,n,e,r),r,i,s,c)}function x(o,t,n,e){let i,s,r,c,h,f,l,a,u,d,y;l=N*n,d=l-(l-n),y=n-d;let g=t[0];i=g*n,l=N*g,a=l-(l-g),u=g-a,r=u*y-(i-a*d-u*d-a*y);let m=0;r!==0&&(e[m++]=r);for(let w=1;w<o;w++)g=t[w],c=g*n,l=N*g,a=l-(l-g),u=g-a,h=u*y-(c-a*d-u*d-a*y),s=i+h,f=s-i,r=i-(s-f)+(h-f),r!==0&&(e[m++]=r),i=c+s,r=s-(i-c),r!==0&&(e[m++]=r);return(i!==0||m===0)&&(e[m++]=i),m}function Qe(o,t){let n=t[0];for(let e=1;e<o;e++)n+=t[e];return n}function Q(o){return new Float64Array(o)}const An=(3+16*dt)*dt,En=(2+12*dt)*dt,On=(9+64*dt)*dt*dt,Lt=Q(4),Te=Q(8),Ne=Q(12),Ce=Q(16),gt=Q(4);function In(o,t,n,e,i,s,r){let c,h,f,l,a,u,d,y,g,m,w,S,E,O,R,I,F,q;const L=o-i,tt=n-i,et=t-s,z=e-s;O=L*z,u=N*L,d=u-(u-L),y=L-d,u=N*z,g=u-(u-z),m=z-g,R=y*m-(O-d*g-y*g-d*m),I=et*tt,u=N*et,d=u-(u-et),y=et-d,u=N*tt,g=u-(u-tt),m=tt-g,F=y*m-(I-d*g-y*g-d*m),w=R-F,a=R-w,Lt[0]=R-(w+a)+(a-F),S=O+w,a=S-O,E=O-(S-a)+(w-a),w=E-I,a=E-w,Lt[1]=E-(w+a)+(a-I),q=S+w,a=q-S,Lt[2]=S-(q-a)+(w-a),Lt[3]=q;let Z=Qe(4,Lt),p=En*r;if(Z>=p||-Z>=p||(a=o-L,c=o-(L+a)+(a-i),a=n-tt,f=n-(tt+a)+(a-i),a=t-et,h=t-(et+a)+(a-s),a=e-z,l=e-(z+a)+(a-s),c===0&&h===0&&f===0&&l===0)||(p=On*r+Je*Math.abs(Z),Z+=L*l+z*c-(et*f+tt*h),Z>=p||-Z>=p))return Z;O=c*z,u=N*c,d=u-(u-c),y=c-d,u=N*z,g=u-(u-z),m=z-g,R=y*m-(O-d*g-y*g-d*m),I=h*tt,u=N*h,d=u-(u-h),y=h-d,u=N*tt,g=u-(u-tt),m=tt-g,F=y*m-(I-d*g-y*g-d*m),w=R-F,a=R-w,gt[0]=R-(w+a)+(a-F),S=O+w,a=S-O,E=O-(S-a)+(w-a),w=E-I,a=E-w,gt[1]=E-(w+a)+(a-I),q=S+w,a=q-S,gt[2]=S-(q-a)+(w-a),gt[3]=q;const b=at(4,Lt,4,gt,Te);O=L*l,u=N*L,d=u-(u-L),y=L-d,u=N*l,g=u-(u-l),m=l-g,R=y*m-(O-d*g-y*g-d*m),I=et*f,u=N*et,d=u-(u-et),y=et-d,u=N*f,g=u-(u-f),m=f-g,F=y*m-(I-d*g-y*g-d*m),w=R-F,a=R-w,gt[0]=R-(w+a)+(a-F),S=O+w,a=S-O,E=O-(S-a)+(w-a),w=E-I,a=E-w,gt[1]=E-(w+a)+(a-I),q=S+w,a=q-S,gt[2]=S-(q-a)+(w-a),gt[3]=q;const _=at(b,Te,4,gt,Ne);O=c*l,u=N*c,d=u-(u-c),y=c-d,u=N*l,g=u-(u-l),m=l-g,R=y*m-(O-d*g-y*g-d*m),I=h*f,u=N*h,d=u-(u-h),y=h-d,u=N*f,g=u-(u-f),m=f-g,F=y*m-(I-d*g-y*g-d*m),w=R-F,a=R-w,gt[0]=R-(w+a)+(a-F),S=O+w,a=S-O,E=O-(S-a)+(w-a),w=E-I,a=E-w,gt[1]=E-(w+a)+(a-I),q=S+w,a=q-S,gt[2]=S-(q-a)+(w-a),gt[3]=q;const M=at(_,Ne,4,gt,Ce);return Ce[M-1]}function Xt(o,t,n,e,i,s){const r=(t-s)*(n-i),c=(o-i)*(e-s),h=r-c,f=Math.abs(r+c);return Math.abs(h)>=An*f?h:-In(o,t,n,e,i,s,f)}const Tn=(10+96*dt)*dt,Nn=(4+48*dt)*dt,Cn=(44+576*dt)*dt*dt,Tt=Q(4),Nt=Q(4),Ct=Q(4),xt=Q(4),Mt=Q(4),St=Q(4),wt=Q(4),mt=Q(4),fe=Q(8),he=Q(8),ue=Q(8),le=Q(8),de=Q(8),pe=Q(8),Ht=Q(8),Zt=Q(8),te=Q(8),jt=Q(4),Pt=Q(4),$t=Q(4),B=Q(8),U=Q(16),nt=Q(16),st=Q(16),H=Q(32),Rt=Q(32),rt=Q(48),bt=Q(64);let Vt=Q(1152),ge=Q(1152);function ot(o,t,n){o=at(o,Vt,t,n,ge);const e=Vt;return Vt=ge,ge=e,o}function Rn(o,t,n,e,i,s,r,c,h){let f,l,a,u,d,y,g,m,w,S,E,O,R,I,F,q,L,tt,et,z,Z,p,b,_,M,v,C,k,A,j,T,P,$,V,D;const X=o-r,W=n-r,Y=i-r,K=t-c,J=e-c,G=s-c;T=W*G,b=N*W,_=b-(b-W),M=W-_,b=N*G,v=b-(b-G),C=G-v,P=M*C-(T-_*v-M*v-_*C),$=Y*J,b=N*Y,_=b-(b-Y),M=Y-_,b=N*J,v=b-(b-J),C=J-v,V=M*C-($-_*v-M*v-_*C),k=P-V,p=P-k,Tt[0]=P-(k+p)+(p-V),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j-$,p=j-k,Tt[1]=j-(k+p)+(p-$),D=A+k,p=D-A,Tt[2]=A-(D-p)+(k-p),Tt[3]=D,T=Y*K,b=N*Y,_=b-(b-Y),M=Y-_,b=N*K,v=b-(b-K),C=K-v,P=M*C-(T-_*v-M*v-_*C),$=X*G,b=N*X,_=b-(b-X),M=X-_,b=N*G,v=b-(b-G),C=G-v,V=M*C-($-_*v-M*v-_*C),k=P-V,p=P-k,Nt[0]=P-(k+p)+(p-V),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j-$,p=j-k,Nt[1]=j-(k+p)+(p-$),D=A+k,p=D-A,Nt[2]=A-(D-p)+(k-p),Nt[3]=D,T=X*J,b=N*X,_=b-(b-X),M=X-_,b=N*J,v=b-(b-J),C=J-v,P=M*C-(T-_*v-M*v-_*C),$=W*K,b=N*W,_=b-(b-W),M=W-_,b=N*K,v=b-(b-K),C=K-v,V=M*C-($-_*v-M*v-_*C),k=P-V,p=P-k,Ct[0]=P-(k+p)+(p-V),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j-$,p=j-k,Ct[1]=j-(k+p)+(p-$),D=A+k,p=D-A,Ct[2]=A-(D-p)+(k-p),Ct[3]=D,f=at(at(at(x(x(4,Tt,X,B),B,X,U),U,x(x(4,Tt,K,B),B,K,nt),nt,H),H,at(x(x(4,Nt,W,B),B,W,U),U,x(x(4,Nt,J,B),B,J,nt),nt,Rt),Rt,bt),bt,at(x(x(4,Ct,Y,B),B,Y,U),U,x(x(4,Ct,G,B),B,G,nt),nt,H),H,Vt);let At=Qe(f,Vt),qt=Nn*h;if(At>=qt||-At>=qt||(p=o-X,l=o-(X+p)+(p-r),p=t-K,d=t-(K+p)+(p-c),p=n-W,a=n-(W+p)+(p-r),p=e-J,y=e-(J+p)+(p-c),p=i-Y,u=i-(Y+p)+(p-r),p=s-G,g=s-(G+p)+(p-c),l===0&&a===0&&u===0&&d===0&&y===0&&g===0)||(qt=Cn*h+Je*Math.abs(At),At+=(X*X+K*K)*(W*g+G*a-(J*u+Y*y))+2*(X*l+K*d)*(W*G-J*Y)+((W*W+J*J)*(Y*d+K*u-(G*l+X*g))+2*(W*a+J*y)*(Y*K-G*X))+((Y*Y+G*G)*(X*y+J*l-(K*a+W*d))+2*(Y*u+G*g)*(X*J-K*W)),At>=qt||-At>=qt))return At;if((a!==0||y!==0||u!==0||g!==0)&&(T=X*X,b=N*X,_=b-(b-X),M=X-_,P=M*M-(T-_*_-(_+_)*M),$=K*K,b=N*K,_=b-(b-K),M=K-_,V=M*M-($-_*_-(_+_)*M),k=P+V,p=k-P,xt[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,xt[1]=j-(k-p)+($-p),D=A+k,p=D-A,xt[2]=A-(D-p)+(k-p),xt[3]=D),(u!==0||g!==0||l!==0||d!==0)&&(T=W*W,b=N*W,_=b-(b-W),M=W-_,P=M*M-(T-_*_-(_+_)*M),$=J*J,b=N*J,_=b-(b-J),M=J-_,V=M*M-($-_*_-(_+_)*M),k=P+V,p=k-P,Mt[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,Mt[1]=j-(k-p)+($-p),D=A+k,p=D-A,Mt[2]=A-(D-p)+(k-p),Mt[3]=D),(l!==0||d!==0||a!==0||y!==0)&&(T=Y*Y,b=N*Y,_=b-(b-Y),M=Y-_,P=M*M-(T-_*_-(_+_)*M),$=G*G,b=N*G,_=b-(b-G),M=G-_,V=M*M-($-_*_-(_+_)*M),k=P+V,p=k-P,St[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,St[1]=j-(k-p)+($-p),D=A+k,p=D-A,St[2]=A-(D-p)+(k-p),St[3]=D),l!==0&&(m=x(4,Tt,l,fe),f=ot(f,yt(x(m,fe,2*X,U),U,x(x(4,St,l,B),B,J,nt),nt,x(x(4,Mt,l,B),B,-G,st),st,H,rt),rt)),d!==0&&(w=x(4,Tt,d,he),f=ot(f,yt(x(w,he,2*K,U),U,x(x(4,Mt,d,B),B,Y,nt),nt,x(x(4,St,d,B),B,-W,st),st,H,rt),rt)),a!==0&&(S=x(4,Nt,a,ue),f=ot(f,yt(x(S,ue,2*W,U),U,x(x(4,xt,a,B),B,G,nt),nt,x(x(4,St,a,B),B,-K,st),st,H,rt),rt)),y!==0&&(E=x(4,Nt,y,le),f=ot(f,yt(x(E,le,2*J,U),U,x(x(4,St,y,B),B,X,nt),nt,x(x(4,xt,y,B),B,-Y,st),st,H,rt),rt)),u!==0&&(O=x(4,Ct,u,de),f=ot(f,yt(x(O,de,2*Y,U),U,x(x(4,Mt,u,B),B,K,nt),nt,x(x(4,xt,u,B),B,-J,st),st,H,rt),rt)),g!==0&&(R=x(4,Ct,g,pe),f=ot(f,yt(x(R,pe,2*G,U),U,x(x(4,xt,g,B),B,W,nt),nt,x(x(4,Mt,g,B),B,-X,st),st,H,rt),rt)),l!==0||d!==0){if(a!==0||y!==0||u!==0||g!==0?(T=a*G,b=N*a,_=b-(b-a),M=a-_,b=N*G,v=b-(b-G),C=G-v,P=M*C-(T-_*v-M*v-_*C),$=W*g,b=N*W,_=b-(b-W),M=W-_,b=N*g,v=b-(b-g),C=g-v,V=M*C-($-_*v-M*v-_*C),k=P+V,p=k-P,wt[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,wt[1]=j-(k-p)+($-p),D=A+k,p=D-A,wt[2]=A-(D-p)+(k-p),wt[3]=D,T=u*-J,b=N*u,_=b-(b-u),M=u-_,b=N*-J,v=b-(b- -J),C=-J-v,P=M*C-(T-_*v-M*v-_*C),$=Y*-y,b=N*Y,_=b-(b-Y),M=Y-_,b=N*-y,v=b-(b- -y),C=-y-v,V=M*C-($-_*v-M*v-_*C),k=P+V,p=k-P,mt[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,mt[1]=j-(k-p)+($-p),D=A+k,p=D-A,mt[2]=A-(D-p)+(k-p),mt[3]=D,F=at(4,wt,4,mt,Zt),T=a*g,b=N*a,_=b-(b-a),M=a-_,b=N*g,v=b-(b-g),C=g-v,P=M*C-(T-_*v-M*v-_*C),$=u*y,b=N*u,_=b-(b-u),M=u-_,b=N*y,v=b-(b-y),C=y-v,V=M*C-($-_*v-M*v-_*C),k=P-V,p=P-k,Pt[0]=P-(k+p)+(p-V),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j-$,p=j-k,Pt[1]=j-(k+p)+(p-$),D=A+k,p=D-A,Pt[2]=A-(D-p)+(k-p),Pt[3]=D,tt=4):(Zt[0]=0,F=1,Pt[0]=0,tt=1),l!==0){const ht=x(F,Zt,l,st);f=ot(f,at(x(m,fe,l,U),U,x(ht,st,2*X,H),H,rt),rt);const ut=x(tt,Pt,l,B);f=ot(f,yt(x(ut,B,2*X,U),U,x(ut,B,l,nt),nt,x(ht,st,l,H),H,Rt,bt),bt),y!==0&&(f=ot(f,x(x(4,St,l,B),B,y,U),U)),g!==0&&(f=ot(f,x(x(4,Mt,-l,B),B,g,U),U))}if(d!==0){const ht=x(F,Zt,d,st);f=ot(f,at(x(w,he,d,U),U,x(ht,st,2*K,H),H,rt),rt);const ut=x(tt,Pt,d,B);f=ot(f,yt(x(ut,B,2*K,U),U,x(ut,B,d,nt),nt,x(ht,st,d,H),H,Rt,bt),bt)}}if(a!==0||y!==0){if(u!==0||g!==0||l!==0||d!==0?(T=u*K,b=N*u,_=b-(b-u),M=u-_,b=N*K,v=b-(b-K),C=K-v,P=M*C-(T-_*v-M*v-_*C),$=Y*d,b=N*Y,_=b-(b-Y),M=Y-_,b=N*d,v=b-(b-d),C=d-v,V=M*C-($-_*v-M*v-_*C),k=P+V,p=k-P,wt[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,wt[1]=j-(k-p)+($-p),D=A+k,p=D-A,wt[2]=A-(D-p)+(k-p),wt[3]=D,z=-G,Z=-g,T=l*z,b=N*l,_=b-(b-l),M=l-_,b=N*z,v=b-(b-z),C=z-v,P=M*C-(T-_*v-M*v-_*C),$=X*Z,b=N*X,_=b-(b-X),M=X-_,b=N*Z,v=b-(b-Z),C=Z-v,V=M*C-($-_*v-M*v-_*C),k=P+V,p=k-P,mt[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,mt[1]=j-(k-p)+($-p),D=A+k,p=D-A,mt[2]=A-(D-p)+(k-p),mt[3]=D,q=at(4,wt,4,mt,te),T=u*d,b=N*u,_=b-(b-u),M=u-_,b=N*d,v=b-(b-d),C=d-v,P=M*C-(T-_*v-M*v-_*C),$=l*g,b=N*l,_=b-(b-l),M=l-_,b=N*g,v=b-(b-g),C=g-v,V=M*C-($-_*v-M*v-_*C),k=P-V,p=P-k,$t[0]=P-(k+p)+(p-V),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j-$,p=j-k,$t[1]=j-(k+p)+(p-$),D=A+k,p=D-A,$t[2]=A-(D-p)+(k-p),$t[3]=D,et=4):(te[0]=0,q=1,$t[0]=0,et=1),a!==0){const ht=x(q,te,a,st);f=ot(f,at(x(S,ue,a,U),U,x(ht,st,2*W,H),H,rt),rt);const ut=x(et,$t,a,B);f=ot(f,yt(x(ut,B,2*W,U),U,x(ut,B,a,nt),nt,x(ht,st,a,H),H,Rt,bt),bt),g!==0&&(f=ot(f,x(x(4,xt,a,B),B,g,U),U)),d!==0&&(f=ot(f,x(x(4,St,-a,B),B,d,U),U))}if(y!==0){const ht=x(q,te,y,st);f=ot(f,at(x(E,le,y,U),U,x(ht,st,2*J,H),H,rt),rt);const ut=x(et,$t,y,B);f=ot(f,yt(x(ut,B,2*J,U),U,x(ut,B,y,nt),nt,x(ht,st,y,H),H,Rt,bt),bt)}}if(u!==0||g!==0){if(l!==0||d!==0||a!==0||y!==0?(T=l*J,b=N*l,_=b-(b-l),M=l-_,b=N*J,v=b-(b-J),C=J-v,P=M*C-(T-_*v-M*v-_*C),$=X*y,b=N*X,_=b-(b-X),M=X-_,b=N*y,v=b-(b-y),C=y-v,V=M*C-($-_*v-M*v-_*C),k=P+V,p=k-P,wt[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,wt[1]=j-(k-p)+($-p),D=A+k,p=D-A,wt[2]=A-(D-p)+(k-p),wt[3]=D,z=-K,Z=-d,T=a*z,b=N*a,_=b-(b-a),M=a-_,b=N*z,v=b-(b-z),C=z-v,P=M*C-(T-_*v-M*v-_*C),$=W*Z,b=N*W,_=b-(b-W),M=W-_,b=N*Z,v=b-(b-Z),C=Z-v,V=M*C-($-_*v-M*v-_*C),k=P+V,p=k-P,mt[0]=P-(k-p)+(V-p),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j+$,p=k-j,mt[1]=j-(k-p)+($-p),D=A+k,p=D-A,mt[2]=A-(D-p)+(k-p),mt[3]=D,I=at(4,wt,4,mt,Ht),T=l*y,b=N*l,_=b-(b-l),M=l-_,b=N*y,v=b-(b-y),C=y-v,P=M*C-(T-_*v-M*v-_*C),$=a*d,b=N*a,_=b-(b-a),M=a-_,b=N*d,v=b-(b-d),C=d-v,V=M*C-($-_*v-M*v-_*C),k=P-V,p=P-k,jt[0]=P-(k+p)+(p-V),A=T+k,p=A-T,j=T-(A-p)+(k-p),k=j-$,p=j-k,jt[1]=j-(k+p)+(p-$),D=A+k,p=D-A,jt[2]=A-(D-p)+(k-p),jt[3]=D,L=4):(Ht[0]=0,I=1,jt[0]=0,L=1),u!==0){const ht=x(I,Ht,u,st);f=ot(f,at(x(O,de,u,U),U,x(ht,st,2*Y,H),H,rt),rt);const ut=x(L,jt,u,B);f=ot(f,yt(x(ut,B,2*Y,U),U,x(ut,B,u,nt),nt,x(ht,st,u,H),H,Rt,bt),bt),d!==0&&(f=ot(f,x(x(4,Mt,u,B),B,d,U),U)),y!==0&&(f=ot(f,x(x(4,xt,-u,B),B,y,U),U))}if(g!==0){const ht=x(I,Ht,g,st);f=ot(f,at(x(R,pe,g,U),U,x(ht,st,2*G,H),H,rt),rt);const ut=x(L,jt,g,B);f=ot(f,yt(x(ut,B,2*G,U),U,x(ut,B,g,nt),nt,x(ht,st,g,H),H,Rt,bt),bt)}}return Vt[f-1]}function Bn(o,t,n,e,i,s,r,c){const h=o-r,f=n-r,l=i-r,a=t-c,u=e-c,d=s-c,y=f*d,g=l*u,m=h*h+a*a,w=l*a,S=h*d,E=f*f+u*u,O=h*u,R=f*a,I=l*l+d*d,F=m*(y-g)+E*(w-S)+I*(O-R),q=(Math.abs(y)+Math.abs(g))*m+(Math.abs(w)+Math.abs(S))*E+(Math.abs(O)+Math.abs(R))*I,L=Tn*q;return F>L||-F>L?F:Rn(o,t,n,e,i,s,r,c,q)}class jn{bs;width;constructor(t,n){this.width=t,this.bs=n}add(t){const n=Math.floor(t/this.width),e=t%this.width;return this.bs[n]|=1<<e,this}delete(t){const n=Math.floor(t/this.width),e=t%this.width;return this.bs[n]&=~(1<<e),this}set(t,n){const e=Math.floor(t/this.width),s=1<<t%this.width;return this.bs[e]^=(-Number(n)^this.bs[e])&s,n}has(t){const n=Math.floor(t/this.width),e=t%this.width;return(this.bs[n]&1<<e)!==0}forEach(t){const n=this.bs.length;for(let e=0;e<n;e++){let i=0;for(;this.bs[e]&&i<this.width;)this.bs[e]&1<<i&&t(e*this.width+i),i++}return this}}class Re extends jn{constructor(t){super(8,new Uint8Array(Math.ceil(t/8)).fill(0))}}function Dt(o){return o%3===2?o-2:o+1}function Et(o){return o%3===0?o+2:o-1}function Be(o,t,n,e,i,s,r,c){const h=Xt(o,t,i,s,r,c),f=Xt(n,e,i,s,r,c);if(h>0&&f>0||h<0&&f<0)return!1;const l=Xt(i,s,o,t,n,e),a=Xt(r,c,o,t,n,e);return l>0&&a>0||l<0&&a<0?!1:h===0&&f===0&&l===0&&a===0?!(Math.max(i,r)<Math.min(o,n)||Math.max(o,n)<Math.min(i,r)||Math.max(s,c)<Math.min(t,e)||Math.max(t,e)<Math.min(s,c)):!0}class Pn{del;constructor(t){this.del=t}}class $n extends Pn{vertMap;flips;consd;constructor(t,n){if(!t||typeof t!="object"||!t.triangles||!t.halfedges||!t.coords)throw new Error("Expected an object with Delaunator output");if(t.triangles.length%3||t.halfedges.length!==t.triangles.length||t.coords.length%2)throw new Error("Delaunator output appears inconsistent");if(t.triangles.length<3)throw new Error("No edges in triangulation");super(t);const e=2**32-1,i=t.coords.length>>1,s=t.triangles.length;this.vertMap=new Uint32Array(i).fill(e),this.flips=new Re(s),this.consd=new Re(s);for(let r=0;r<s;r++){const c=t.triangles[r];this.vertMap[c]===e&&this.updateVert(r)}n&&this.constrainAll(n)}constrainOne(t,n){const{triangles:e,halfedges:i}=this.del,s=this.vertMap[t];let r=s;do{const f=e[r],l=Dt(r);if(f===n)return this.protect(r);const a=Et(r),u=e[a];if(u===n)return this.protect(l),l;if(this.intersectSegments(t,n,u,f)){r=a;break}r=i[l]}while(r!==-1&&r!==s);let c=r,h=-1;for(;r!==-1;){const f=i[r],l=Et(r),a=Et(f),u=Dt(f);if(f===-1)throw new Error("Constraining edge exited the hull");if(this.consd.has(r))throw new Error("Edge intersects already constrained edge");if(this.isCollinear(t,n,e[r])||this.isCollinear(t,n,e[f]))throw new Error("Constraining edge intersects point");if(!this.intersectSegments(e[r],e[f],e[l],e[a])){if(h===-1&&(h=r),e[a]===n){if(r===h)throw new Error("Infinite loop: non-convex quadrilateral");r=h,h=-1;continue}if(this.intersectSegments(t,n,e[a],e[f]))r=a;else if(this.intersectSegments(t,n,e[u],e[a]))r=u;else if(h===r)throw new Error("Infinite loop: no further intersect after non-convex");continue}if(this.flipDiagonal(r),this.intersectSegments(t,n,e[l],e[a])&&(h===-1&&(h=l),h===l))throw new Error("Infinite loop: flipped diagonal still intersects");e[a]===n?(c=a,r=h,h=-1):this.intersectSegments(t,n,e[u],e[a])&&(r=u)}return this.protect(c),this.delaunify(!0),this.findEdge(t,n)}delaunify(t=!1){const{halfedges:n}=this.del,e=this.flips,i=this.consd,s=n.length;let r;do{r=0;for(let c=0;c<s;c++){if(i.has(c))continue;e.delete(c);const h=n[c];h!==-1&&(e.delete(h),this.isDelaunay(c)||(this.flipDiagonal(c),r++))}}while(t&&r>0);return this}constrainAll(t){const n=t.length;for(let e=0;e<n;e++){const i=t[e];this.constrainOne(i[0],i[1])}return this}isConstrained(t){return this.consd.has(t)}findEdge(t,n){const e=this.vertMap[n],{triangles:i,halfedges:s}=this.del;let r=e,c=-1;do{if(i[r]===t)return r;c=Dt(r),r=s[c]}while(r!==-1&&r!==e);return i[Dt(c)]===t?-c:1/0}protect(t){const n=this.del.halfedges[t],e=this.flips,i=this.consd;return e.delete(t),i.add(t),n!==-1?(e.delete(n),i.add(n),n):-t}markFlip(t){const n=this.del.halfedges,e=this.flips;if(this.consd.has(t))return!1;const s=n[t];return s!==-1&&(e.add(t),e.add(s)),!0}flipDiagonal(t){const{triangles:n,halfedges:e}=this.del,i=this.flips,s=this.consd,r=e[t],c=Et(t),h=Dt(t),f=Et(r),l=Dt(r),a=e[c],u=e[f];if(s.has(t))throw new Error("Trying to flip a constrained edge");return n[t]=n[f],e[t]=u,i.set(t,i.has(f))||s.set(t,s.has(f)),u!==-1&&(e[u]=t),e[c]=f,n[r]=n[c],e[r]=a,i.set(r,i.has(c))||s.set(r,s.has(c)),a!==-1&&(e[a]=r),e[f]=c,this.markFlip(t),this.markFlip(h),this.markFlip(r),this.markFlip(l),i.add(c),s.delete(c),i.add(f),s.delete(f),this.updateVert(t),this.updateVert(h),this.updateVert(r),this.updateVert(l),c}isCollinear(t,n,e){const i=this.del.coords;return Xt(i[t*2],i[t*2+1],i[n*2],i[n*2+1],i[e*2],i[e*2+1])===0}inCircle(t,n,e,i){const s=this.del.coords;return Bn(s[t*2],s[t*2+1],s[n*2],s[n*2+1],s[e*2],s[e*2+1],s[i*2],s[i*2+1])<0}isDelaunay(t){const{triangles:n,halfedges:e}=this.del,i=e[t];if(i===-1)return!0;const s=n[Et(t)],r=n[t],c=n[Dt(t)],h=n[Et(i)];return!this.inCircle(s,r,c,h)}updateVert(t){const{triangles:n,halfedges:e}=this.del,i=this.vertMap,s=n[t];let r=Et(t),c=e[r];for(;c!==-1&&c!==t;)r=Et(c),c=e[r];return i[s]=r,r}intersectSegments(t,n,e,i){const s=this.del.coords;return t===e||t===i||n===e||n===i?!1:Be(s[t*2],s[t*2+1],s[n*2],s[n*2+1],s[e*2],s[e*2+1],s[i*2],s[i*2+1])}static intersectSegments=Be}function Wt(o,t,n){if(t||(t=[]),typeof o!="object"||o.type!=="FeatureCollection")throw"Argument points must be FeatureCollection";if(!Array.isArray(t))throw"Argument points must be Array of Array";const e=o.features.map(h=>h.geometry.coordinates),i=on.from(e);let s;const r=[];i.triangles.length!==0&&t.length!==0&&(s=new $n(i),s.constrainAll(t));for(let h=0;h<i.triangles.length;h+=3)r.push([i.triangles[h],i.triangles[h+1],i.triangles[h+2]]);const c=["a","b","c"];return ft.featureCollection(r.map(h=>{const f={},l=h.map((a,u)=>{const d=o.features[a],y=d.geometry.coordinates,g=[y[0],y[1]];return y.length===3?g[2]=y[2]:f[c[u]]=d.properties[n],g});return l[3]=l[0],ft.polygon([l],f)}))}function Ke(o,t,n,e,i,s){return Object.keys(o).reduce((r,c)=>{const h=o[c],f=h.forw,l=h.bakw,a={forw:[f[0]-t.forw[0],f[1]-t.forw[1]],bakw:[l[0]-t.bakw[0],l[1]-t.bakw[1]]},u=a.forw[0]===0?1/0:((a.forw[0]<0?n:e)-t.forw[0])/a.forw[0],d=a.forw[1]===0?1/0:((a.forw[1]<0?i:s)-t.forw[1])/a.forw[1];if(Math.abs(u)/Math.abs(d)<1.1){const y={forw:[a.forw[0]*u+t.forw[0],a.forw[1]*u+t.forw[1]],bakw:[a.bakw[0]*u+t.bakw[0],a.bakw[1]*u+t.bakw[1]]};a.forw[0]<0?r[3].push(y):r[1].push(y)}if(Math.abs(d)/Math.abs(u)<1.1){const y={forw:[a.forw[0]*d+t.forw[0],a.forw[1]*d+t.forw[1]],bakw:[a.bakw[0]*d+t.bakw[0],a.bakw[1]*d+t.bakw[1]]};a.forw[1]<0?r[0].push(y):r[2].push(y)}return r},[[],[],[],[]])}function Dn(o,t){const n=[[],[],[],[]],e=[];return Object.keys(o).forEach(i=>{const s=o[i],r=s.forw,c=s.bakw,h=[r[0]-t.forw[0],r[1]-t.forw[1]],f=[c[0]-t.bakw[0],t.bakw[1]-c[1]],l={forw:h,bakw:f};if(e.push(l),h[0]===0||h[1]===0)return;let a=0;h[0]>0&&(a+=1),h[1]>0&&(a+=2),n[a].push(l)}),{perQuad:n,aggregate:e}}function Fn(o){let t=1/0,n=0,e=0;return o.forEach(i=>{const{forw:s,bakw:r}=i,c=Math.hypot(s[0],s[1]),h=Math.hypot(r[0],r[1]);if(h===0)return;const f=c/h,l=Math.atan2(s[0],s[1])-Math.atan2(r[0],r[1]);t=Math.min(t,f),n+=Math.cos(l),e+=Math.sin(l)}),isFinite(t)?[t,Math.atan2(e,n)]:[1,0]}function Ge(o,t,n){const{perQuad:e,aggregate:i}=Dn(o,t),s=e.every(h=>h.length>0);let r;n==="birdeye"&&s?r=e:n==="birdeye"?r=[i]:s?r=e:r=[i];const c=r.map(h=>Fn(h));return c.length===1?[c[0],c[0],c[0],c[0]]:c}function Un(o,t,n){const e=[1,1,1,1];for(let i=0;i<4;i++){const s=(i+1)%4,r=ft.lineString([o[i].bakw,o[s].bakw]);t[i].map(c=>{const h=ft.lineString([n.bakw,c.bakw]),f=cn(r,h);if(f.features.length>0&&f.features[0].geometry){const l=f.features[0],a=Math.sqrt(Math.pow(c.bakw[0]-n.bakw[0],2)+Math.pow(c.bakw[1]-n.bakw[1],2)),u=Math.sqrt(Math.pow(l.geometry.coordinates[0]-n.bakw[0],2)+Math.pow(l.geometry.coordinates[1]-n.bakw[1],2)),d=a/u;d>e[i]&&(e[i]=d),d>e[s]&&(e[s]=d)}})}o.forEach((i,s)=>{const r=e[s],c=[(i.bakw[0]-n.bakw[0])*r+n.bakw[0],(i.bakw[1]-n.bakw[1])*r+n.bakw[1]];i.bakw=c})}function He(o,t,n,e){const i=o.map((r,c)=>{const h=t[c],f=[h[0]-n.forw[0],h[1]-n.forw[1]],a=Math.sqrt(Math.pow(f[0],2)+Math.pow(f[1],2))/r[0],u=Math.atan2(f[0],f[1])-r[1],d=[n.bakw[0]+a*Math.sin(u),n.bakw[1]-a*Math.cos(u)];return{forw:h,bakw:d}}),s=i[2];return i[2]=i[3],i[3]=s,Un(i,e,n),i}function Ln(o){const{convexBuf:t,centroid:n,bbox:e,minx:i,maxx:s,miny:r,maxy:c}=o,h=Ke(t,n,i,s,r,c),f=Ge(t,n,"plain");return He(f,e,n,h)}function Vn(o){const{convexBuf:t,centroid:n,bbox:e,minx:i,maxx:s,miny:r,maxy:c}=o,h=Ke(t,n,i,s,r,c),f=Ge(t,n,"birdeye");return He(f,e,n,h)}function Ze(o){const n=new qn(o).findSegmentIntersections();return nn(n).reduce((e,i,s,r)=>Array.isArray(e)||(e||(e={}),e[`${i.x}:${i.y}`]=i,s!=r.length-1)?e:Object.keys(e).map(c=>ft.point([e[c].x,e[c].y])),{})}class qn{_xx;_yy;_ii;_nn;_zz;_zlimit=0;_bb;_allBounds;_arcIter;_filteredArcIter;buf;constructor(t){this.initArcs(t)}initArcs(t){const n=[],e=[],i=t.map(s=>{const r=s?s.length:0;for(let c=0;c<r;c++)n.push(s[c][0]),e.push(s[c][1]);return r});this.initXYData(i,n,e)}initXYData(t,n,e){const i=t.length;this._xx=new Float64Array(n),this._yy=new Float64Array(e),this._nn=new Uint32Array(t),this._zz=null,this._zlimit=0,this._filteredArcIter=null,this._ii=new Uint32Array(i);let s=0;for(let r=0;r<i;r++)this._ii[r]=s,s+=t[r];(s!=this._xx.length||this._xx.length!=this._yy.length)&&be("ArcCollection#initXYData() Counting error"),this.initBounds(),this._arcIter=new fs(this._xx,this._yy)}initBounds(){const t=this.calcArcBounds_(this._xx,this._yy,this._nn);this._bb=t.bb,this._allBounds=t.bounds}calcArcBounds_(t,n,e){const i=e.length,s=new Float64Array(i*4),r=new oe;let c=0,h,f,l;for(let a=0;a<i;a++)h=e[a],h>0&&(f=a*4,l=hs(t,n,c,h),s[f++]=l[0],s[f++]=l[1],s[f++]=l[2],s[f]=l[3],c+=h,r.mergeBounds(l));return{bb:s,bounds:r}}getBounds(){return this._allBounds.clone()}forEachSegment(t){let n=0;for(let e=0,i=this.size();e<i;e++)n+=this.forEachArcSegment(e,t);return n}size(){return this._ii&&this._ii.length||0}forEachArcSegment(t,n){const e=t>=0,i=e?t:~t,s=this.getRetainedInterval(),r=this._nn[i],c=e?1:-1;let h=e?this._ii[i]:this._ii[i]+r-1,f=h,l=0;for(let a=1;a<r;a++)f+=c,(s===0||this._zz[f]>=s)&&(n(h,f,this._xx,this._yy),h=f,l++);return l}getRetainedInterval(){return this._zlimit}getVertexData(){return{xx:this._xx,yy:this._yy,zz:this._zz,bb:this._bb,nn:this._nn,ii:this._ii}}getUint32Array(t){const n=t*4;return(!this.buf||this.buf.byteLength<n)&&(this.buf=new ArrayBuffer(n)),new Uint32Array(this.buf,0,t)}getAvgSegment2(){let t=0,n=0;const e=this.forEachSegment((i,s,r,c)=>{t+=Math.abs(r[i]-r[s]),n+=Math.abs(c[i]-c[s])});return[t/e||0,n/e||0]}calcSegmentIntersectionStripeCount(){const t=this.getBounds().height(),n=this.getAvgSegment2()[1];let e=1;return n>0&&t>0&&(e=Math.ceil(t/n/20)),e||1}findSegmentIntersections(){const t=this.getBounds(),n=t.ymin,e=t.ymax-n,i=this.calcSegmentIntersectionStripeCount(),s=new Uint32Array(i),r=i>1?g=>Math.floor((i-1)*(g-n)/e):()=>0;let c,h;this.forEachSegment((g,m,w,S)=>{let E=r(S[g]);const O=r(S[m]);for(;s[E]=s[E]+2,E!=O;)E+=O>E?1:-1});const f=this.getUint32Array(Wn(s));let l=0;const a=[];Yn(s,g=>{const m=l;l+=g,a.push(f.subarray(m,l))}),Jn(s,0),this.forEachSegment((g,m,w,S)=>{let E=r(S[g]);const O=r(S[m]);let R,I;for(;R=s[E],s[E]=R+2,I=a[E],I[R]=g,I[R+1]=m,E!=O;)E+=O>E?1:-1});const u=this.getVertexData(),d=[];let y;for(c=0;c<i;c++)for(y=Qn(a[c],u.xx,u.yy),h=0;h<y.length;h++)d.push(y[h]);return nn(d)}}function be(...o){const t=o.join(" ");throw new Error(t)}function ye(o){return o?Xn(o)?!0:zn(o)?!1:o.length===0?!0:o.length>0:!1}function zn(o){return o!=null&&o.toString===String.prototype.toString}function Xn(o){return Array.isArray(o)}function Wn(o,t){ye(o)||be("utils.sum() expects an array, received:",o);let n=0,e;for(let i=0,s=o.length;i<s;i++)e=o[i],e&&(n+=e);return n}function Yn(o,t,n){if(!ye(o))throw new Error(`#forEach() takes an array-like argument. ${o}`);for(let e=0,i=o.length;e<i;e++)t.call(n,o[e],e)}function Jn(o,t){for(let n=0,e=o.length;n<e;n++)o[n]=t;return o}function Qn(o,t,n){const e=o.length-2,i=[];let s,r,c,h,f,l,a,u,d,y,g,m,w,S,E,O,R;for(rs(t,o),O=0;O<e;){for(s=o[O],r=o[O+1],f=t[s],l=t[r],d=n[s],y=n[r],R=O;R<e&&(R+=2,c=o[R],a=t[c],!(l<a));){if(g=n[c],h=o[R+1],u=t[h],m=n[h],d>=g){if(d>m&&y>g&&y>m)continue}else if(d<m&&y<g&&y<m)continue;s==c||s==h||r==c||r==h||(w=Kn(f,d,l,y,a,g,u,m),w&&(S=[s,r],E=[c,h],i.push(Pe(w,S,E,t,n)),w.length==4&&i.push(Pe(w.slice(2),S,E,t,n))))}O+=2}return i}function Kn(o,t,n,e,i,s,r,c){const h=Gn(o,t,n,e,i,s,r,c);let f=null;return h&&(f=Hn(o,t,n,e,i,s,r,c),f?is(o,t,n,e,i,s,r,c)&&(f=null):f=ss(o,t,n,e,i,s,r,c)),f}function Gn(o,t,n,e,i,s,r,c){return Yt(o,t,n,e,i,s)*Yt(o,t,n,e,r,c)<=0&&Yt(i,s,r,c,o,t)*Yt(i,s,r,c,n,e)<=0}function Yt(o,t,n,e,i,s){return tn(o-i,t-s,n-i,e-s)}function tn(o,t,n,e){return o*e-t*n}function Hn(o,t,n,e,i,s,r,c){let h=ee(o,t,n,e,i,s,r,c),f;return h&&(f=ts(h[0],h[1],o,t,n,e,i,s,r,c),f==1?h=ee(n,e,o,t,i,s,r,c):f==2?h=ee(i,s,r,c,o,t,n,e):f==3&&(h=ee(r,c,i,s,o,t,n,e))),h&&ns(h,o,t,n,e,i,s,r,c),h}function ee(o,t,n,e,i,s,r,c){const h=tn(n-o,e-t,r-i,c-s),f=1e-18;let l;if(h===0)return null;const a=Yt(i,s,r,c,o,t)/h;return h<=f&&h>=-f?l=Zn(o,t,n,e,i,s,r,c):l=[o+a*(n-o),t+a*(e-t)],l}function Zn(o,t,n,e,i,s,r,c){let h=null;return!Ot(o,i,r)&&!Ot(t,s,c)?h=[o,t]:!Ot(n,i,r)&&!Ot(e,s,c)?h=[n,e]:!Ot(i,o,n)&&!Ot(s,t,e)?h=[i,s]:!Ot(r,o,n)&&!Ot(c,t,e)&&(h=[r,c]),h}function Ot(o,t,n){let e;return t<n?e=o<t||o>n:t>n?e=o>t||o<n:e=o!=t,e}function ts(o,t,...n){let e=-1,i=1/0,s;for(let r=0,c=0,h=n.length;c<h;r++,c+=2)s=es(o,t,n[c],n[c+1]),s<i&&(i=s,e=r);return e}function es(o,t,n,e){const i=o-n,s=t-e;return i*i+s*s}function ns(o,t,n,e,i,s,r,c,h){let f=o[0],l=o[1];f=ne(f,t,e),f=ne(f,s,c),l=ne(l,n,i),l=ne(l,r,h),o[0]=f,o[1]=l}function ne(o,t,n){let e;return Ot(o,t,n)&&(e=Math.abs(o-t)<Math.abs(o-n)?t:n,o=e),o}function ss(o,t,n,e,i,s,r,c){const h=Math.min(o,n,i,r),f=Math.max(o,n,i,r),l=Math.min(t,e,s,c),a=Math.max(t,e,s,c),u=a-l>f-h;let d=[];return(u?Bt(t,l,a):Bt(o,h,f))&&d.push(o,t),(u?Bt(e,l,a):Bt(n,h,f))&&d.push(n,e),(u?Bt(s,l,a):Bt(i,h,f))&&d.push(i,s),(u?Bt(c,l,a):Bt(r,h,f))&&d.push(r,c),(d.length!=2&&d.length!=4||d.length==4&&d[0]==d[2]&&d[1]==d[3])&&(d=null),d}function is(o,t,n,e,i,s,r,c){return o==i&&t==s||o==r&&t==c||n==i&&e==s||n==r&&e==c}function Bt(o,t,n){return o>t&&o<n}function rs(o,t){os(o,t),en(o,t,0,t.length-2)}function os(o,t){for(let n=0,e=t.length;n<e;n+=2)o[t[n]]>o[t[n+1]]&&cs(t,n,n+1)}function cs(o,t,n){const e=o[t];o[t]=o[n],o[n]=e}function en(o,t,n,e){let i=n,s=e,r,c;for(;i<e;){for(r=o[t[n+e>>2<<1]];i<=s;){for(;o[t[i]]<r;)i+=2;for(;o[t[s]]>r;)s-=2;i<=s&&(c=t[i],t[i]=t[s],t[s]=c,c=t[i+1],t[i+1]=t[s+1],t[s+1]=c,i+=2,s-=2)}if(s-n<40?je(o,t,n,s):en(o,t,n,s),e-i<40){je(o,t,i,e);return}n=i,s=e}}function je(o,t,n,e){let i,s;for(let r=n+2;r<=e;r+=2){i=t[r],s=t[r+1];let c;for(c=r-2;c>=n&&o[i]<o[t[c]];c-=2)t[c+2]=t[c],t[c+3]=t[c+1];t[c+2]=i,t[c+3]=s}}function Pe(o,t,n,e,i){const s=o[0],r=o[1];t=$e(s,r,t[0],t[1],e,i),n=$e(s,r,n[0],n[1],e,i);const c=t[0]<n[0]?t:n,h=c==t?n:t;return{x:s,y:r,a:c,b:h}}function $e(o,t,n,e,i,s){let r=n<e?n:e,c=r===n?e:n;return i[r]==o&&s[r]==t?c=r:i[c]==o&&s[c]==t&&(r=c),[r,c]}function nn(o){const t={};return o.filter(n=>{const e=as(n);return e in t?!1:(t[e]=!0,!0)})}function as(o){return`${o.a.join(",")};${o.b.join(",")}`}class fs{_i=0;_n=0;_inc=1;_xx;_yy;i=0;x=0;y=0;constructor(t,n){this._xx=t,this._yy=n}}function hs(o,t,n,e){let i=n|0;const s=isNaN(e)?o.length-i:e+i;let r,c,h,f,l,a;if(s>0)h=l=o[i],f=a=t[i];else return[void 0,void 0,void 0,void 0];for(i++;i<s;i++)r=o[i],c=t[i],r<h&&(h=r),r>l&&(l=r),c<f&&(f=c),c>a&&(a=c);return[h,f,l,a]}class oe{xmin;ymin;xmax;ymax;constructor(...t){t.length>0&&this.setBounds(t)}cloneBounds(){return this.clone()}clone(){return new oe(this.xmin,this.ymin,this.xmax,this.ymax)}width(){return this.xmax-this.xmin||0}height(){return this.ymax-this.ymin||0}setBounds(t,n,e,i){return arguments.length==1&&(ye(t)?(n=t[1],e=t[2],i=t[3],t=t[0]):(n=t.ymin,e=t.xmax,i=t.ymax,t=t.xmin)),this.xmin=t,this.ymin=n,this.xmax=e,this.ymax=i,(t>e||n>i)&&this.update(),this}update(){let t;this.xmin>this.xmax&&(t=this.xmin,this.xmin=this.xmax,this.xmax=t),this.ymin>this.ymax&&(t=this.ymin,this.ymin=this.ymax,this.ymax=t)}mergeBounds(t,...n){let e,i,s,r;return t instanceof oe?(e=t.xmin,i=t.ymin,s=t.xmax,r=t.ymax):n.length==3?(e=t,i=n[0],s=n[1],r=n[2]):t.length==4?(e=t[0],i=t[1],s=t[2],r=t[3]):be("Bounds#mergeBounds() invalid argument:",t),this.xmin===void 0?this.setBounds(e,i,s,r):(e<this.xmin&&(this.xmin=e),i<this.ymin&&(this.ymin=i),s>this.xmax&&(this.xmax=s),r>this.ymax&&(this.ymax=r)),this}}function ce(o){const t=["a","b","c"].map(n=>o.properties[n].index);return[[0,1],[0,2],[1,2],[0,1,2]].map(n=>n.map(e=>t[e]).sort().join("-")).sort()}function ke(o,t,n){const e=ce(t.forw),i=ce(t.bakw);if(JSON.stringify(e)!=JSON.stringify(i))throw`${JSON.stringify(t,null,2)}
${JSON.stringify(e)}
${JSON.stringify(i)}`;for(let s=0;s<e.length;s++){const r=e[s];o[r]||(o[r]=[]),o[r].push(t)}n&&(n.forw.features.push(t.forw),n.bakw.features.push(t.bakw))}function De(o,t,n){const e=ce(t.forw),i=ce(t.bakw);if(JSON.stringify(e)!=JSON.stringify(i))throw`${JSON.stringify(t,null,2)}
${JSON.stringify(e)}
${JSON.stringify(i)}`;if(e.forEach(s=>{const r=o[s];if(!r)return;const c=r.filter(h=>h!==t);c.length===0?delete o[s]:o[s]=c}),n){const s=(r,c)=>{!r||!c||(r.features=r.features.filter(h=>h!==c))};s(n.forw,t.forw),s(n.bakw,t.bakw)}}function Jt(o,t,n){return ft.point(o,{target:{geom:t,index:n}})}function Qt(o){return ft.point(o.properties.target.geom,{target:{geom:o.geometry.coordinates,index:o.properties.target.index}})}function me(o,t){const n=t.geometry.coordinates;return[0,1,2,3].map(e=>{const i=(e+1)%4,s=o[e],r=o[i],c=s.geometry.coordinates,h=Math.atan2(c[0]-n[0],c[1]-n[1]),f=[t,s,r,t].map(u=>u.geometry.coordinates),l={a:{geom:t.properties.target.geom,index:t.properties.target.index},b:{geom:s.properties.target.geom,index:s.properties.target.index},c:{geom:r.properties.target.geom,index:r.properties.target.index}},a=ft.featureCollection([ft.polygon([f],l)]);return[h,a]}).reduce((e,i)=>(e[0].push(i[0]),e[1].push(i[1]),e),[[],[]])}function us(o){const{tins:t,targets:n,includeReciprocals:e}=o,i={};n.forEach(r=>{const c=t[r];if(!c||!c.features)return;i[r]={};const h={};c.features.forEach(f=>{const l=["a","b","c"];for(let a=0;a<3;a++){const u=(a+1)%3,d=l[a],y=l[u],g=f.properties[d].index,m=f.properties[y].index,w=[g,m].sort().join("-");if(h[w])continue;h[w]=!0;const S=f.geometry.coordinates[0][a],E=f.geometry.coordinates[0][u],O=f.properties[d].geom,R=f.properties[y].geom,I=Math.sqrt(Math.pow(O[0]-R[0],2)+Math.pow(O[1]-R[1],2))/Math.sqrt(Math.pow(S[0]-E[0],2)+Math.pow(S[1]-E[1],2)),F=i[r];F[`${g}:${w}`]=I,F[`${m}:${w}`]=I}})});const s={};return e&&(s.bakw={}),n.forEach(r=>{const c=i[r];if(s[r]={},!c)return;const h={};Object.keys(c).forEach(l=>{const[a]=l.split(":");h[a]||(h[a]=[]),h[a].push(c[l])}),Object.keys(h).forEach(l=>{const a=h[l],u=a.reduce((d,y)=>d+y,0)/a.length;s[r][l]=u,e&&s.bakw&&(s.bakw[l]=1/u)});let f=0;for(let l=0;l<4;l++){const a=`b${l}`,u=s[r][a]||0;f+=u}s[r].c=f/4,e&&s.bakw&&(s.bakw.c=1/s[r].c)}),s}function ls(o,t){const n=o.split("-");if(n.length!==2||!n.every(s=>/^-?\d+$/.test(s)))return!1;const[e,i]=n.map(s=>parseInt(s,10)).sort((s,r)=>s-r);return t.some(s=>{if(s.length!==2)return!1;const r=s.map(h=>parseInt(`${h}`,10));if(r.some(h=>Number.isNaN(h)))return!1;const c=r.sort((h,f)=>h-f);return c[0]===e&&c[1]===i})}function Fe(o){return["a","b","c"].map((t,n)=>({prop:o.properties[t],geom:o.geometry.coordinates[0][n]}))}function ds(o,t,n){let e=!1,i=!0;for(;i;){i=!1;const s=Object.keys(t);for(const r of s){const c=t[r];if(!c||c.length<2||ls(r,n))continue;const h=r.split("-"),f=Fe(c[0].bakw),l=Fe(c[1].bakw),a=h.map(m=>f.find(w=>`${w.prop.index}`===m)||l.find(w=>`${w.prop.index}`===m));if(a.some(m=>!m))continue;const u=[f,l].map(m=>m.find(w=>!h.includes(`${w.prop.index}`)));if(u.some(m=>!m))continue;const d=c[0].bakw.geometry.coordinates[0].slice(0,3).map(m=>se(m)),y=c[1].bakw.geometry.coordinates[0].slice(0,3).map(m=>se(m));if(Ue(se(u[0].geom),y)||Ue(se(u[1].geom),d)){De(t,c[0],o),De(t,c[1],o),a.forEach(m=>{if(!m)return;const w=[m.geom,u[0].geom,u[1].geom,m.geom],S={a:m.prop,b:u[0].prop,c:u[1].prop},E=ft.polygon([w],S),O=ze(E);ke(t,{forw:O,bakw:E},o)}),e=!0,i=!0;break}}}return e}function se(o){return[o[0],o[1]]}function Ue(o,t){const[n,e]=t[0],[i,s]=t[1],[r,c]=t[2],h=r-n,f=c-e,l=i-n,a=s-e,u=o[0]-n,d=o[1]-e,y=h*h+f*f,g=h*l+f*a,m=h*u+f*d,w=l*l+a*a,S=l*u+a*d,E=y*w-g*g;if(E===0)return!1;const O=1/E,R=(w*m-g*S)*O,I=(y*S-g*m)*O,F=1e-9;return R>=-F&&I>=-F&&R+I<=1+F}const Le=re;class ct extends vn{importance;priority;pointsSet;constructor(t={}){super(),t.bounds?this.setBounds(t.bounds):(this.setWh(t.wh),this.vertexMode=t.vertexMode||ct.VERTEX_PLAIN),this.strictMode=t.strictMode||ct.MODE_AUTO,this.yaxisMode=t.yaxisMode||ct.YAXIS_INVERT,this.importance=t.importance||0,this.priority=t.priority||0,this.stateFull=t.stateFull||!1,t.points&&this.setPoints(t.points),t.edges&&this.setEdges(t.edges)}getFormatVersion(){return Le}setPoints(t){this.yaxisMode===ct.YAXIS_FOLLOW&&(t=t.map(n=>[n[0],[n[1][0],-1*n[1][1]]])),this.points=t,this.tins=void 0,this.indexedTins=void 0}setEdges(t=[]){this.edges=We(t),this.edgeNodes=void 0,this.tins=void 0,this.indexedTins=void 0}setBounds(t){this.bounds=t;let n=t[0][0],e=n,i=t[0][1],s=i;const r=[t[0]];for(let c=1;c<t.length;c++){const h=t[c];h[0]<n&&(n=h[0]),h[0]>e&&(e=h[0]),h[1]<i&&(i=h[1]),h[1]>s&&(s=h[1]),r.push(h)}r.push(t[0]),this.boundsPolygon=ft.polygon([r]),this.xy=[n,i],this.wh=[e-n,s-i],this.vertexMode=ct.VERTEX_PLAIN,this.tins=void 0,this.indexedTins=void 0}getCompiled(){const t={};t.version=Le,t.points=this.points,t.weight_buffer=this.pointsWeightBuffer,t.centroid_point=[this.centroid.forw.geometry.coordinates,this.centroid.forw.properties.target.geom],t.vertices_params=[this.vertices_params.forw[0],this.vertices_params.bakw[0]],t.vertices_points=[];const n=this.vertices_params.forw[1];return n&&[0,1,2,3].map(e=>{const i=n[e].features[0],s=i.geometry.coordinates[0][1],r=i.properties.b.geom;t.vertices_points[e]=[s,r]}),t.strict_status=this.strict_status,t.tins_points=[[]],this.tins.forw.features.map(e=>{t.tins_points[0].push(["a","b","c"].map(i=>e.properties[i].index))}),this.strict_status===ct.STATUS_LOOSE?(t.tins_points[1]=[],this.tins.bakw.features.map(e=>{t.tins_points[1].push(["a","b","c"].map(i=>e.properties[i].index))})):this.strict_status===ct.STATUS_ERROR&&this.kinks?.bakw&&(t.kinks_points=this.kinks.bakw.features.map(e=>e.geometry.coordinates)),t.yaxisMode=this.yaxisMode,t.vertexMode=this.vertexMode,t.strictMode=this.strictMode,this.bounds?(t.bounds=this.bounds,t.boundsPolygon=this.boundsPolygon,t.xy=this.xy,t.wh=this.wh):t.wh=this.wh,t.edges=this.edges,t.edgeNodes=this.edgeNodes,t}setWh(t){this.wh=t||[100,100],this.xy=[0,0],this.bounds=void 0,this.boundsPolygon=void 0,this.tins=void 0,this.indexedTins=void 0}setVertexMode(t){this.vertexMode=t,this.tins=void 0,this.indexedTins=void 0}setStrictMode(t){this.strictMode=t,this.tins=void 0,this.indexedTins=void 0}calcurateStrictTin(){const t=this.tins.forw.features.map(i=>ze(i));this.tins.bakw=ft.featureCollection(t);const n={};this.tins.forw.features.forEach((i,s)=>{const r=this.tins.bakw.features[s];ke(n,{forw:i,bakw:r})}),ds(this.tins,n,this.pointsSet?.edges||[]);const e=["forw","bakw"].map(i=>{const s=this.tins[i].features.map(r=>r.geometry.coordinates[0]);return Ze(s)});e[0].length===0&&e[1].length===0?(this.strict_status=ct.STATUS_STRICT,delete this.kinks):(this.strict_status=ct.STATUS_ERROR,this.kinks={},e[0].length>0&&(this.kinks.forw=ft.featureCollection(e[0])),e[1].length>0&&(this.kinks.bakw=ft.featureCollection(e[1])))}generatePointsSet(){const t={forw:[],bakw:[]};for(let i=0;i<this.points.length;i++){const s=this.points[i][0],r=this.points[i][1],c=Jt(s,r,i);t.forw.push(c),t.bakw.push(Qt(c))}const n=[];let e=0;this.edgeNodes=[],this.edges||(this.edges=[]);for(let i=0;i<this.edges.length;i++){const s=this.edges[i][2],r=Object.assign([],this.edges[i][0]),c=Object.assign([],this.edges[i][1]);if(r.length===0&&c.length===0){n.push(s);continue}r.unshift(this.points[s[0]][0]),r.push(this.points[s[1]][0]),c.unshift(this.points[s[0]][1]),c.push(this.points[s[1]][1]);const h=[r,c].map(f=>{const l=f.map((u,d,y)=>{if(d===0)return 0;const g=y[d-1];return Math.sqrt(Math.pow(u[0]-g[0],2)+Math.pow(u[1]-g[1],2))}),a=l.reduce((u,d,y)=>y===0?[0]:(u.push(u[y-1]+d),u),[]);return a.map((u,d,y)=>{const g=u/y[y.length-1];return[f[d],l[d],a[d],g]})});h.map((f,l)=>{const a=h[l?0:1];return f.filter((u,d)=>!(d===0||d===f.length-1||u[4]==="handled")).map(u=>{const d=u[0],y=u[3],g=a.reduce((m,w,S,E)=>{if(m)return m;const O=E[S+1];if(w[3]===y)return w[4]="handled",[w];if(w[3]<y&&O&&O[3]>y)return[w,O]},void 0);if(g&&g.length===1)return l===0?[d,g[0][0],y]:[g[0][0],d,y];if(g&&g.length===2){const m=g[0],w=g[1],S=(y-m[3])/(w[3]-m[3]),E=[(w[0][0]-m[0][0])*S+m[0][0],(w[0][1]-m[0][1])*S+m[0][1]];return l===0?[d,E,y]:[E,d,y]}return[]})}).reduce((f,l)=>f.concat(l),[]).sort((f,l)=>f[2]<l[2]?-1:1).map((f,l,a)=>{this.edgeNodes[e]=[f[0],f[1]];const u=Jt(f[0],f[1],`e${e}`);e++,t.forw.push(u),t.bakw.push(Qt(u)),l===0?n.push([s[0],t.forw.length-1]):n.push([t.forw.length-2,t.forw.length-1]),l===a.length-1&&n.push([t.forw.length-1,s[1]])})}return{forw:t.forw,bakw:t.bakw,edges:n}}validateAndPrepareInputs(){const t=this.xy[0]-.05*this.wh[0],n=this.xy[0]+1.05*this.wh[0],e=this.xy[1]-.05*this.wh[1],i=this.xy[1]+1.05*this.wh[1];if(!this.points.reduce((c,h)=>c&&(this.bounds?sn(h[0],this.boundsPolygon):h[0][0]>=t&&h[0][0]<=n&&h[0][1]>=e&&h[0][1]<=i),!0))throw"SOME POINTS OUTSIDE";let r=[];return this.wh&&(r=[[t,e],[n,e],[t,i],[n,i]]),{pointsSet:this.generatePointsSet(),bbox:r,minx:t,maxx:n,miny:e,maxy:i}}updateTin(){let t=this.strictMode;t!==ct.MODE_STRICT&&t!==ct.MODE_LOOSE&&(t=ct.MODE_AUTO);const{pointsSet:n,bbox:e,minx:i,maxx:s,miny:r,maxy:c}=this.validateAndPrepareInputs(),h={forw:ft.featureCollection(n.forw),bakw:ft.featureCollection(n.bakw)},f=Wt(h.forw,n.edges,"target"),l=Wt(h.bakw,n.edges,"target");if(f.features.length===0||l.features.length===0)throw"TOO LINEAR1";const a=rn(h.forw),u=_e(h.forw);if(!u)throw"TOO LINEAR2";const d={},y=u.geometry.coordinates[0];let g;try{g=y.map(L=>({forw:L,bakw:ie(ft.point(L),f)})),g.forEach(L=>{d[`${L.forw[0]}:${L.forw[1]}`]=L})}catch{throw"TOO LINEAR2"}const m=_e(h.bakw);if(!m)throw"TOO LINEAR2";const w=m.geometry.coordinates[0];try{g=w.map(L=>({bakw:L,forw:ie(ft.point(L),l)})),g.forEach(L=>{d[`${L.forw[0]}:${L.forw[1]}`]=L})}catch{throw"TOO LINEAR2"}const S={forw:a.geometry.coordinates,bakw:ie(a,f)},E=Jt(S.forw,S.bakw,"c");this.centroid={forw:E,bakw:Qt(E)};const O={convexBuf:d,centroid:S,bbox:e,minx:i,maxx:s,miny:r,maxy:c},R=this.vertexMode===ct.VERTEX_BIRDEYE?Vn(O):Ln(O),I={forw:[],bakw:[]};for(let L=0;L<R.length;L++){const tt=R[L].forw,et=R[L].bakw,z=Jt(tt,et,`b${L}`),Z=Qt(z);n.forw.push(z),n.bakw.push(Z),I.forw.push(z),I.bakw.push(Z)}this.pointsSet={forw:ft.featureCollection(n.forw),bakw:ft.featureCollection(n.bakw),edges:n.edges},this.tins={forw:Ee(Wt(this.pointsSet.forw,n.edges,"target"))},(t===ct.MODE_STRICT||t===ct.MODE_AUTO)&&this.calcurateStrictTin(),(t===ct.MODE_LOOSE||t===ct.MODE_AUTO&&this.strict_status===ct.STATUS_ERROR)&&(this.tins.bakw=Ee(Wt(this.pointsSet.bakw,n.edges,"target")),delete this.kinks,this.strict_status=ct.STATUS_LOOSE),this.vertices_params={forw:me(I.forw,this.centroid.forw),bakw:me(I.bakw,this.centroid.bakw)},this.addIndexedTin();const F=["forw"];this.strict_status===ct.STATUS_LOOSE&&F.push("bakw");const q=this.strict_status===ct.STATUS_STRICT;this.pointsWeightBuffer=us({tins:this.tins,targets:F,includeReciprocals:q})}async updateTinAsync(){this.updateTin()}}exports.Tin=ct;exports.constrainedTin=Wt;exports.counterPoint=Qt;exports.createPoint=Jt;exports.findIntersections=Ze;exports.format_version=re;exports.insertSearchIndex=ke;exports.vertexCalc=me;
